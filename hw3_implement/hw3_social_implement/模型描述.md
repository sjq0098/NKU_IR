# Lite-EIISRS Architecture for LastFM Recommendation

本节以 LastFM 数据集为例，从输入到输出，逐层详述 Lite-EIISRS（轻量化 EIISRS）的模型架构与计算流程。

---

## 1. 数据与输入

- **LastFM 概况**  
  - 用户数 $N\approx1{,}892$  
  - 物品（艺术家/标签）数 $M\approx17{,}632$  
  - 交互（二值化播放记录）矩阵 $R\in\{0,1\}^{N\times M}$  
  - 社交图邻接矩阵 $S\in\{0,1\}^{N\times N}$（显式好友关系）

- **输入管道**  
  1. 加载二值交互数据，构建用户–物品**双向邻接**：  
     - $A_{UI} = D_u^{-1}R$  
     - $A_{IU} = D_i^{-1}R^\top$  
  2. 加载用户社交边，构建**归一化社交邻接**  
     - $S = D_s^{-1}S_{\text{raw}}$  
  3. 统计特征：用户度、物品度、交互频率、时间衰减等  

---

## 2. 嵌入初始化

### 2.1 协同过滤（MF）初始化  
- 目标：快速得到低维潜在因子  
- 求解：最小化  
  $$\min_{U_{\mathrm{MF}},V_{\mathrm{MF}}}\ \|R - U_{\mathrm{MF}}V_{\mathrm{MF}}^\top\|^2 + \lambda\|\cdot\|^2$$  
- 输出：  
  $$U_{\mathrm{MF}}\in\mathbb{R}^{N\times d_{\mathrm{cf}}},\quad V_{\mathrm{MF}}\in\mathbb{R}^{M\times d_{\mathrm{cf}}}.$$

### 2.2 截断 SVD 初始化  
- 分解：  
  $$R \approx \tilde U\,\Sigma\,\tilde V^\top$$  
- 取前 $d_{\mathrm{svd}}$ 奇异值，构造：  
  $$U_{\mathrm{SVD}} = \tilde U\,\Sigma^{1/2},\quad V_{\mathrm{SVD}} = \tilde V\,\Sigma^{1/2}.$$

### 2.3 统计特征处理  
- 特征维度：$f$  
- MLP 变换：  
  ```text
  h1 = LeakyReLU( LayerNorm(x @ W1 + b1) )
  F = h1 @ W2 + b2   # F ∈ ℝ^{d}
  ```  
- 分别得到用户特征嵌入 $F_u$ 和物品特征嵌入 $F_i$。

---

## 3. LightGCN 消息传递

> **作用**：捕获用户–物品二跳及更高阶协同过滤信息  
> **公式**（每层 $l$）：
```math
U^{(l+1)} = A_{UI}\,V^{(l)} \;+\; \alpha\,U^{(0)},\quad
V^{(l+1)} = A_{IU}\,U^{(l)} \;+\; \alpha\,V^{(0)},\quad \alpha=0.1
```
- 初始：$U^{(0)}$, $V^{(0)}$ 由 MF/SVD 拼接或平均  
- 堆叠 $L$ 层后，收集多层嵌入 $\{U^{(l)},V^{(l)}\}_{l=0}^L$  

---

## 4. SocialGCN 卷积

> **作用**：注入高阶社交影响信号  
> **公式**（每层 $l$）：
```math
\widetilde U^{(l)} = S\,(U^{(l)}W_s^{(l)}),\quad
U^{(l+1)} = U^{(l)} + \mathrm{Dropout}(\widetilde U^{(l)})\,,\quad p=0.1
```
- $W_s^{(l)}\in\mathbb{R}^{d\times d}$ 可学习  
- 输出层级社交嵌入 $\{U^{(l)}_s\}_{l=0}^{L_s}$  

---

## 5. 融合与注意力

### 5.1 拼接多源嵌入  
对每个用户 $u$，将以下向量拼接：
1. $u_{\mathrm{MF}}$ （协同过滤）  
2. $u_{\mathrm{SVD}}$ （SVD）  
3. $F_u$ （统计特征）  
4. $U^{(L)}$ （LightGCN 最后一层）  
5. $U_s^{(L_s)}$ （SocialGCN 最后一层）  
```math
Z_u = [\,u_{\mathrm{MF}}\;\|\;u_{\mathrm{SVD}}\;\|\;F_u\;\|\;U^{(L)}\;\|\;U_s^{(L_s)}\,]\,\in\mathbb{R}^{d_{\mathrm{tot}}}
```

### 5.2 多头注意力  
- 头数 $h=2$  
- 线性映射：$Q,ZK,ZV = Z_uW_Q,Z_uW_K,Z_uW_V$  
- 缩放点积注意力：  
  ```math
  \mathrm{Attn}(Q,K,V) = \mathrm{softmax}\Bigl(\frac{QK^\top}{\sqrt{d_{\mathrm{tot}}/h}}\Bigr)\,V
  ```
- 输出残差融合：  
  ```math
  U_{\mathrm{fused}} = Z_u + \mathrm{Attn}(Q,K,V)
  ```

---

## 6. 最终输出与残差

- **用户向量**  
  ```math
  u_{\mathrm{final}} = \mathrm{MLP}_{\mathrm{out}}([\,U^{(0)}\|\;U_{\mathrm{fused}}\,]) + \beta\,U^{(0)},\quad \beta=0.2
  ```
- **物品向量** 同理得到 $v_{\mathrm{final}}$  

---

## 7. 损失与训练

- **简化 BPR 损失**：
  ```math
  \mathcal{L}_{\mathrm{BPR}}
    = -\frac{1}{B}\sum_{i=1}^B \ln\sigma\bigl(u_{\mathrm{final},i}^\top v_{\mathrm{pos},i}
    - u_{\mathrm{final},i}^\top v_{\mathrm{neg},i}\bigr)
  ```
- **$\ell_2$ 正则**：
  ```math
  \mathcal{L} = \mathcal{L}_{\mathrm{BPR}}
    + \lambda_r \bigl\|\Theta\bigr\|_2^2
  ```
- **优化器**：Adam（lr=1e-3）  
- **批次大小**：$B=1024$  
- **训练轮次**：20–50 epochs  

---

## 8. 总结

Lite-EIISRS 在 LastFM 上结合了经典 MF/SVD 初始化、统计特征、LightGCN 与 SocialGCN，以及轻量级多头注意力与残差 MLP，保证在低算力环境中依然能高效挖掘用户–物品与用户–用户社交信号，实现优质的个性化推荐。